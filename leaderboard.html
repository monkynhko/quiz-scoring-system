<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>Quiz Leaderboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <style>
    .qr-container { text-align: right; margin-bottom: 1em; }
    .archive-list { margin-top: 2em; }
  </style>
</head>
<body>
  <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
    <div id="archive-list-container" style="width:100%; display:flex; justify-content:flex-start; align-items:center; margin-bottom:24px;">
      <!-- Dropdown sa vlo쮂 sem -->
    </div>
    <div id="leaderboard"></div>
    <div id="fallback" style="color: red; display: none; margin-top:16px;">
      Nepodarilo sa na캜칤ta콘 leaderboard z datab치zy. Sk칰코am fallback...
    </div>
  </div>
  <script>
    // === SUPABASE KONFIG ===
    const SUPABASE_URL = 'https://rpkipyfafkdndcaoedtq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwa2lweWZhZmtkbmRjYW9lZHRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNzU5MDUsImV4cCI6MjA3NDc1MTkwNX0.qYsJffts9lkaUIdCDRM_4Yj9EP0-3yCAgNj8SMMH_VY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // QR k칩d odstr치nen칳

    // Zisti quizId z URL
    const urlParams = new URLSearchParams(window.location.search);
    const quizId = urlParams.get('quizId');

    // === Interakt칤vny dropdown na v칳ber quizu ===
    function renderQuizDropdown(quizzes, onSelect, label = 'Vyber quiz:') {
      let old = document.getElementById('quizDropdown');
      if (old) old.remove();
      const container = document.createElement('div');
      container.id = 'quizDropdown';
      container.style = 'display:flex; align-items:center; gap:12px; margin-left:24px;';
      const lbl = document.createElement('label');
      lbl.textContent = 'Kv칤zy:';
      lbl.style = 'font-weight:bold; font-size:1.1em; color:#0ff; margin-right:8px;';
      container.appendChild(lbl);
      const select = document.createElement('select');
      select.style = 'padding:8px 16px; font-size:1.1em; border-radius:12px; border:1px solid #0ff; background:#222; color:#0ff; margin-right:12px;';
      quizzes.forEach(q => {
        const option = document.createElement('option');
        option.value = q.id;
        option.textContent = `${q.title} (${q.created_at?.slice(0,10)})`;
        select.appendChild(option);
      });
      container.appendChild(select);
      const btn = document.createElement('button');
      btn.textContent = 'Zobrazi콘';
      btn.className = 'neon-button';
      btn.style = 'margin-left:8px;';
      btn.onclick = () => {
        onSelect(select.value);
      };
      container.appendChild(btn);
      document.getElementById('archive-list-container').innerHTML = '';
      document.getElementById('archive-list-container').appendChild(container);
    }

    let currentQuizId = quizId;

    async function renderLeaderboard(quizIdOverride) {
      let data;
      try {
        let idToUse = quizIdOverride || currentQuizId;
        // Ak nie je quizId, automaticky zober najnov코칤 quiz
        if (!idToUse) {
          const { data: quiz } = await supabase
            .from('quizzes')
            .select('id, title, created_at')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
          if (!quiz) throw new Error('콯iadny quiz');
          idToUse = quiz.id;
        }
        // Fetch konkr칠tny quiz
        const { data: quiz } = await supabase
          .from('quizzes')
          .select('id, title, created_at')
          .eq('id', idToUse)
          .single();
        if (!quiz) throw new Error('Quiz nen치jden칳');
  data = await fetchLeaderboardForQuiz(quiz.id);
  renderTable(data);
  await renderArchive();
      } catch (e) {
        document.getElementById('fallback').style.display = '';
        // Fallback: na캜칤taj leaderboard.json
        try {
          const resp = await fetch('leaderboard.json');
          if (!resp.ok) throw new Error('Chyba na캜칤tania snapshotu');
          const snapshot = await resp.json();
          renderTable(snapshot);
        } catch (e2) {
          document.getElementById('leaderboard').innerHTML =
            '<p>Leaderboard nie je dostupn칳.</p>';
        }
      }
    }

    async function fetchLeaderboardForQuiz(quizId) {
      const { data: teams, error: teamsError } = await supabase
        .from('teams')
        .select('id, name')
        .eq('quiz_id', quizId);
      const { data: rounds, error: roundsError } = await supabase
        .from('rounds')
        .select('id, name, round_order')
        .eq('quiz_id', quizId)
        .order('round_order');
      const { data: scores, error: scoresError } = await supabase
        .from('scores')
        .select('team_id, round_id, score');
      // Debug panel odstr치nen칳
      // Spo캜칤taj total per team
      // V칳po캜et leaderboardu a 코tatist칤k
      const leaderboard = (teams || []).map(team => {
        let total = 0;
        let roundScores = [];
        (rounds || []).forEach(round => {
          const s = (scores || []).find(
            sc => sc.team_id === team.id && sc.round_id === round.id
          );
          const score = s ? Number(s.score) : 0;
          total += score;
          roundScores.push(score);
        });
        return { team: team.name, teamId: team.id, total, roundScores };
      });
      leaderboard.sort((a, b) => b.total - a.total);

      // 맚atistiky
      let stats = {
        topScore: { team: '', score: 0 },
        easiestRound: { round: '', avgScore: 0 },
        hardestRound: { round: '', avgScore: Infinity },
        bestRound: { team: '', round: '', score: 0 }
      };
      (rounds || []).forEach(round => {
        let roundTotal = 0;
        (teams || []).forEach(team => {
          const s = (scores || []).find(
            sc => sc.team_id === team.id && sc.round_id === round.id
          );
          const score = s ? Number(s.score) : 0;
          roundTotal += score;
          if (score > stats.bestRound.score) {
            stats.bestRound = { team: team.name, round: round.name, score };
          }
        });
        const avgScore = roundTotal / (teams?.length || 1);
        if (avgScore > stats.easiestRound.avgScore) {
          stats.easiestRound = { round: round.name, avgScore };
        }
        if (avgScore < stats.hardestRound.avgScore) {
          stats.hardestRound = { round: round.name, avgScore };
        }
      });
      leaderboard.forEach(row => {
        if (row.total > stats.topScore.score) {
          stats.topScore = { team: row.team, score: row.total };
        }
      });
      return { leaderboard, rounds, stats };
    }

    function renderTable(data) {
      if (!data || !data.leaderboard) {
        document.getElementById('leaderboard').innerHTML = '<p>콯iadne d치ta.</p>';
        return;
      }
      // Medaily SVG s farbami
      const medals = [
        '<span class="medal gold" style="color:#FFD700;" title="1. miesto">游볞</span>',
        '<span class="medal silver" style="color:#C0C0C0;" title="2. miesto">游볟</span>',
        '<span class="medal bronze" style="color:#CD7F32;" title="3. miesto">游볠</span>'
      ];
      const trophy = '<span class="trophy" title="Trofej">游끥</span>';
      const playerIcon = '<span class="player-icon">&#128100;</span>';
      // Dynamick칠 st컄pce pre kol치
      let html = `<div class="leaderboard-modern single-col">
        <div class="leaderboard-header">Leaderboard</div>
        <div class="leaderboard-col" style="width:75vw; max-width:900px; margin:0 auto;">
          <div class="leaderboard-row leaderboard-row-header">
            <div class="leaderboard-cell">&nbsp;</div>
            <div class="leaderboard-cell">T칤m</div>
            
            ${(data.rounds||[]).map((r, idx) => `<div class='leaderboard-cell round-score-header'>${idx+1}. kolo</div>`).join('')}
             <div class='leaderboard-cell total-score-header'>S칰캜et</div>
          </div>`;
      data.leaderboard.forEach((row, i) => {
        html += `<div class="leaderboard-row${i < 3 ? ' leaderboard-top' : ''}">
          <div class="leaderboard-cell">${i < 3 ? medals[i] : ''}</div>
          <div class="leaderboard-cell">${row.team}</div>
          
          ${(row.roundScores||[]).map(score => `<div class='leaderboard-cell round-score-cell'>${score}</div>`).join('')}
           <div class='leaderboard-cell total-score-cell'><b>${row.total}</b></div>
        </div>`;
      });
      html += '</div></div>';
      document.getElementById('leaderboard').innerHTML = html;
    }

    function renderStatistics(data) {
      if (!data || !data.stats) return;
      document.getElementById('topScore').textContent = `${data.stats.topScore.team} (${data.stats.topScore.score} bodov)`;
      document.getElementById('easiestRound').textContent = `${data.stats.easiestRound.round} (${Math.round(data.stats.easiestRound.avgScore)} bodov priemer)`;
      document.getElementById('hardestRound').textContent = `${data.stats.hardestRound.round} (${Math.round(data.stats.hardestRound.avgScore)} bodov priemer)`;
      document.getElementById('bestRound').textContent = `${data.stats.bestRound.team} (${data.stats.bestRound.round}: ${data.stats.bestRound.score} bodov)`;
    }

    async function renderArchive() {
      const { data: quizzes } = await supabase
        .from('quizzes')
        .select('id, title, created_at')
        .order('created_at', { ascending: false })
        .limit(20);
      renderQuizDropdown(quizzes || [], async (quizId) => {
        currentQuizId = quizId;
        await renderLeaderboard(quizId);
      }, 'Kv칤zy:');
    }

    renderLeaderboard();
  </script>
</body>
</html>
