<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>Quiz Leaderboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <style>
    .qr-container { text-align: right; margin-bottom: 1em; }
    .archive-list { margin-top: 2em; }
  </style>
</head>
<body>
  <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
    <div id="archive-list-container" style="width:100%; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; margin-bottom:24px;">
      <!-- Dropdown sa vlo쮂 sem -->
    </div>
    <div id="leaderboard"></div>
    <div id="fallback" style="color: red; display: none; margin-top:16px;">
      Nepodarilo sa na캜칤ta콘 leaderboard z datab치zy. Sk칰코am fallback...
    </div>
  </div>
  <script>
    // === SUPABASE KONFIG ===
    const SUPABASE_URL = 'https://rpkipyfafkdndcaoedtq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwa2lweWZhZmtkbmRjYW9lZHRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNzU5MDUsImV4cCI6MjA3NDc1MTkwNX0.qYsJffts9lkaUIdCDRM_4Yj9EP0-3yCAgNj8SMMH_VY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // QR k칩d odstr치nen칳

    // Zisti quizId z URL
    const urlParams = new URLSearchParams(window.location.search);
    const quizId = urlParams.get('quizId');

    // === Interakt칤vny dropdown na v칳ber quizu ===
    function renderQuizDropdown(quizzes, onSelect, label = 'Vyber quiz:') {
      const root = document.getElementById('archive-list-container');
      // create view controls area (league / quiz) if missing
      let controlsArea = root.querySelector('.view-controls');
      if (!controlsArea) {
        controlsArea = document.createElement('div');
        controlsArea.className = 'view-controls';
        controlsArea.style = 'display:flex; align-items:center; justify-content:center; width:100%; margin-bottom:12px;';
        // create a single row matching leaderboard width: toggle centered, dropdown on right
        const controlsRow = document.createElement('div');
        controlsRow.className = 'controls-row';
        controlsRow.style = 'width:75vw; max-width:900px; display:flex; align-items:center; justify-content:space-between; margin:12px auto;';

        // centered toggle wrapper
        const toggleWrapper = document.createElement('div');
        toggleWrapper.style = 'flex:1; display:flex; justify-content:center; padding-right:12px;';
        const toggleBtn = document.createElement('button');
        function updateToggleText() {
          toggleBtn.textContent = currentView === 'league' ? 'Zobrazi콘 aktu치lny leaderboard' : 'Zobrazi콘 ligov칠 sk칩re';
        }
        updateToggleText();
        toggleBtn.className = 'neon-button';
        toggleBtn.style = 'width:100%; max-width:600px; padding:12px 18px; font-size:1.05em; border-radius:12px; text-align:center;';
        toggleBtn.onclick = async () => {
          currentView = currentView === 'league' ? 'quiz' : 'league';
          updateToggleText();
          if (currentView === 'league') {
            await renderLeaderboard();
          } else {
            await renderLeaderboard(currentQuizId);
          }
        };
        toggleWrapper.appendChild(toggleBtn);

        // right-side placeholder for dropdown; will be filled below
        const rightArea = document.createElement('div');
        rightArea.className = 'controls-right';
        rightArea.style = 'display:flex; align-items:center; gap:12px;';

        controlsRow.appendChild(toggleWrapper);
        controlsRow.appendChild(rightArea);
        controlsArea.appendChild(controlsRow);
        root.appendChild(controlsArea);
      }

      // dropdown area (separate so controlsArea isn't wiped)
      // find or create dropdown area inside the controls row's right area
      let dropdownArea = root.querySelector('.controls-right .dropdown-area');
      if (!dropdownArea) {
        const rightArea = root.querySelector('.controls-right');
        dropdownArea = document.createElement('div');
        dropdownArea.className = 'dropdown-area';
        dropdownArea.style = 'display:flex; align-items:center; gap:12px;';
        if (rightArea) rightArea.appendChild(dropdownArea); else root.appendChild(dropdownArea);
      }

      // clear and recreate dropdown
      dropdownArea.innerHTML = '';
      let old = document.getElementById('quizDropdown');
      if (old) old.remove();
      const container = document.createElement('div');
      container.id = 'quizDropdown';
      container.style = 'display:flex; align-items:center; gap:12px;';
      const lbl = document.createElement('label');
      lbl.textContent = 'Kv칤zy:';
      lbl.style = 'font-weight:bold; font-size:1.1em; color:#0ff; margin-right:8px;';
      container.appendChild(lbl);
      const select = document.createElement('select');
      select.style = 'padding:8px 16px; font-size:1.1em; border-radius:12px; border:1px solid #0ff; background:#222; color:#0ff; margin-right:12px;';
      quizzes.forEach(q => {
        const option = document.createElement('option');
        option.value = q.id;
        option.textContent = `${q.title} (${q.created_at?.slice(0,10)})`;
        select.appendChild(option);
      });
      container.appendChild(select);
      const btn = document.createElement('button');
      btn.textContent = 'Zobrazi콘';
      btn.className = 'neon-button';
      btn.style = 'margin-left:8px;';
      btn.onclick = () => {
        onSelect(select.value);
      };
      container.appendChild(btn);
      dropdownArea.appendChild(container);
    }

    let currentQuizId = quizId;
    let currentView = 'quiz'; // 'quiz' or 'league'

    async function renderLeaderboard(quizIdOverride) {
      let data;
      try {
        let idToUse = quizIdOverride || currentQuizId;
        // If league view selected, fetch aggregated league across quizzes
        if (currentView === 'league') {
          const leagueData = await fetchLeague();
          renderLeagueTable(leagueData);
          await renderArchive();
          return;
        }
        // Ak nie je quizId, automaticky zober najnov코칤 quiz
        if (!idToUse) {
          const { data: quiz } = await supabase
            .from('quizzes')
            .select('id, title, created_at')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
          if (!quiz) throw new Error('콯iadny quiz');
          idToUse = quiz.id;
        }
        // Fetch konkr칠tny quiz
        const { data: quiz } = await supabase
          .from('quizzes')
          .select('id, title, created_at')
          .eq('id', idToUse)
          .single();
        if (!quiz) throw new Error('Quiz nen치jden칳');
    data = await fetchLeaderboardForQuiz(quiz.id);
  renderTable(data);
  await renderArchive();
      } catch (e) {
        document.getElementById('fallback').style.display = '';
        // Fallback: na캜칤taj leaderboard.json
        try {
          const resp = await fetch('leaderboard.json');
          if (!resp.ok) throw new Error('Chyba na캜칤tania snapshotu');
          const snapshot = await resp.json();
          renderTable(snapshot);
        } catch (e2) {
          document.getElementById('leaderboard').innerHTML =
            '<p>Leaderboard nie je dostupn칳.</p>';
        }
      }
    }

    // --- Helper: normalize team names (remove diacritics + lowercase) ---
    function normalizeTeamName(name) {
      if (!name) return '';
      try {
        // decompose diacritics and remove combining marks
        return name.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .toLowerCase()
          .trim();
      } catch (e) {
        // Fallback simple normalization
        return name.replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
      }
    }

    // --- League aggregation: sum points by normalized team name across all quizzes ---
    async function fetchLeague() {
      // Fetch all teams and all scores
      const { data: teams } = await supabase
        .from('teams')
        .select('id, name');
      const { data: scores } = await supabase
        .from('scores')
        .select('team_id, score');

      const teamById = {};
      (teams || []).forEach(t => { teamById[t.id] = (t.name || '').trim(); });

      // Aggregate by normalized name, but keep counts of original spellings
      const agg = {}; // norm -> { total, appearancesSet, nameCounts, firstSeen }
      (scores || []).forEach(s => {
        const teamId = s.team_id;
        const original = (teamById[teamId] || 'Unknown').trim();
        const norm = normalizeTeamName(original) || original.toLowerCase();
        if (!agg[norm]) agg[norm] = { total: 0, appearancesSet: new Set(), nameCounts: {}, firstSeen: original };
        const scoreVal = Number(s.score) || 0;
        agg[norm].total += scoreVal;
        agg[norm].appearancesSet.add(teamId);
        agg[norm].nameCounts[original] = (agg[norm].nameCounts[original] || 0) + 1;
      });

      const league = Object.keys(agg).map(norm => {
        const entry = agg[norm];
        // pick the most common original spelling for display
        const names = Object.keys(entry.nameCounts);
        names.sort((a, b) => entry.nameCounts[b] - entry.nameCounts[a]);
        const displayName = names[0] || entry.firstSeen || norm;
        return { team: displayName, total: entry.total, appearances: entry.appearancesSet.size };
      }).sort((a, b) => b.total - a.total);

      return { league };
    }

    function renderLeagueTable(data) {
      const list = (data && data.league) || [];
      if (!list.length) {
        document.getElementById('leaderboard').innerHTML = '<p>콯iadne ligov칠 d치ta.</p>';
        return;
      }
      let html = `<div class="leaderboard-modern single-col">
        <div class="leaderboard-header">Liga - S칰캜et bodov</div>
        <div class="leaderboard-col" style="width:75vw; max-width:900px; margin:0 auto;">
          <div class="leaderboard-row leaderboard-row-header">
            <div class="leaderboard-cell">&nbsp;</div>
            <div class="leaderboard-cell">T칤m</div>
            <div class='leaderboard-cell'>칔캜asti</div>
            <div class='leaderboard-cell'>S칰캜et</div>
          </div>`;
      list.forEach((row, i) => {
        html += `<div class="leaderboard-row${i < 3 ? ' leaderboard-top' : ''}">
          <div class="leaderboard-cell">${i < 3 ? ['游볞','游볟','游볠'][i] : ''}</div>
          <div class="leaderboard-cell">${row.team}</div>
          <div class='leaderboard-cell'>${row.appearances}</div>
          <div class='leaderboard-cell total-score-cell'><b>${row.total}</b></div>
        </div>`;
      });
      html += '</div></div>';
      document.getElementById('leaderboard').innerHTML = html;
    }

    async function fetchLeaderboardForQuiz(quizId) {
      const { data: teams, error: teamsError } = await supabase
        .from('teams')
        .select('id, name')
        .eq('quiz_id', quizId);
      const { data: rounds, error: roundsError } = await supabase
        .from('rounds')
        .select('id, name, round_order')
        .eq('quiz_id', quizId)
        .order('round_order');
      const { data: scores, error: scoresError } = await supabase
        .from('scores')
        .select('team_id, round_id, score');
      // Debug panel odstr치nen칳
      // Spo캜칤taj total per team
      // V칳po캜et leaderboardu a 코tatist칤k
      const leaderboard = (teams || []).map(team => {
        let total = 0;
        let roundScores = [];
        (rounds || []).forEach(round => {
          const s = (scores || []).find(
            sc => sc.team_id === team.id && sc.round_id === round.id
          );
          const score = s ? Number(s.score) : 0;
          total += score;
          roundScores.push(score);
        });
        return { team: team.name, teamId: team.id, total, roundScores };
      });
      leaderboard.sort((a, b) => b.total - a.total);

      // 맚atistiky
      let stats = {
        topScore: { team: '', score: 0 },
        easiestRound: { round: '', avgScore: 0 },
        hardestRound: { round: '', avgScore: Infinity },
        bestRound: { team: '', round: '', score: 0 }
      };
      (rounds || []).forEach(round => {
        let roundTotal = 0;
        (teams || []).forEach(team => {
          const s = (scores || []).find(
            sc => sc.team_id === team.id && sc.round_id === round.id
          );
          const score = s ? Number(s.score) : 0;
          roundTotal += score;
          if (score > stats.bestRound.score) {
            stats.bestRound = { team: team.name, round: round.name, score };
          }
        });
        const avgScore = roundTotal / (teams?.length || 1);
        if (avgScore > stats.easiestRound.avgScore) {
          stats.easiestRound = { round: round.name, avgScore };
        }
        if (avgScore < stats.hardestRound.avgScore) {
          stats.hardestRound = { round: round.name, avgScore };
        }
      });
      leaderboard.forEach(row => {
        if (row.total > stats.topScore.score) {
          stats.topScore = { team: row.team, score: row.total };
        }
      });
      return { leaderboard, rounds, stats };
    }

    function renderTable(data) {
      if (!data || !data.leaderboard) {
        document.getElementById('leaderboard').innerHTML = '<p>콯iadne d치ta.</p>';
        return;
      }
      // Medaily SVG s farbami
      const medals = [
        '<span class="medal gold" style="color:#FFD700;" title="1. miesto">游볞</span>',
        '<span class="medal silver" style="color:#C0C0C0;" title="2. miesto">游볟</span>',
        '<span class="medal bronze" style="color:#CD7F32;" title="3. miesto">游볠</span>'
      ];
      const trophy = '<span class="trophy" title="Trofej">游끥</span>';
      const playerIcon = '<span class="player-icon">&#128100;</span>';
      // Dynamick칠 st컄pce pre kol치
      let html = `<div class="leaderboard-modern single-col">
        <div class="leaderboard-header">Leaderboard</div>
        <div class="leaderboard-col" style="width:75vw; max-width:900px; margin:0 auto;">
          <div class="leaderboard-row leaderboard-row-header">
            <div class="leaderboard-cell">&nbsp;</div>
            <div class="leaderboard-cell">T칤m</div>
            
            ${(data.rounds||[]).map((r, idx) => `<div class='leaderboard-cell round-score-header'>${idx+1}. kolo</div>`).join('')}
             <div class='leaderboard-cell total-score-header'>S칰캜et</div>
          </div>`;
      data.leaderboard.forEach((row, i) => {
        html += `<div class="leaderboard-row${i < 3 ? ' leaderboard-top' : ''}">
          <div class="leaderboard-cell">${i < 3 ? medals[i] : ''}</div>
          <div class="leaderboard-cell">${row.team}</div>
          
          ${(row.roundScores||[]).map(score => `<div class='leaderboard-cell round-score-cell'>${score}</div>`).join('')}
           <div class='leaderboard-cell total-score-cell'><b>${row.total}</b></div>
        </div>`;
      });
      html += '</div></div>';
      document.getElementById('leaderboard').innerHTML = html;
    }

    function renderStatistics(data) {
      if (!data || !data.stats) return;
      document.getElementById('topScore').textContent = `${data.stats.topScore.team} (${data.stats.topScore.score} bodov)`;
      document.getElementById('easiestRound').textContent = `${data.stats.easiestRound.round} (${Math.round(data.stats.easiestRound.avgScore)} bodov priemer)`;
      document.getElementById('hardestRound').textContent = `${data.stats.hardestRound.round} (${Math.round(data.stats.hardestRound.avgScore)} bodov priemer)`;
      document.getElementById('bestRound').textContent = `${data.stats.bestRound.team} (${data.stats.bestRound.round}: ${data.stats.bestRound.score} bodov)`;
    }

    async function renderArchive() {
      const { data: quizzes } = await supabase
        .from('quizzes')
        .select('id, title, created_at')
        .order('created_at', { ascending: false })
        .limit(20);
      renderQuizDropdown(quizzes || [], async (quizId) => {
        currentQuizId = quizId;
        await renderLeaderboard(quizId);
      }, 'Kv칤zy:');
    }

    renderLeaderboard();
  </script>
</body>
</html>
